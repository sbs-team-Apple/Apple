<!DOCTYPE html>
<html layout:decorate="~{/common/layout}">
        <meta charset="UTF-8">
        <title>Title</title>
</head>
<body>

<div layout:fragment="content" class="container my-3">


        <div> 내 채팅방 목록들</div>

        <div> 내가 초대한 채팅방</div>
        <div class="flex" th:each="room2 : ${chatRoom2}">
               <div class="chat-subject" th:text="${room2.siteUser2.nickname}+'님과 채팅방'">

               </div>
            <div>
                <form method="get" th:action="@{|/chat/${room2.id}/room3?userId2=${room2.siteUser2.id}|}">
                <input type="hidden" name="userId2" th:value="${room2.siteUser2.id}">
                <button type="submit" >채팅방 입장</button>
                </form>
              </div>
            <div class="room-id" th:data-room-id="${room2.id}"></div>
        </div>


        <div> 내가 초대받은 채팅방</div>
        <div class="flex"   th:each="room3 : ${chatRoom3}">
               <div th:text="${room3.siteUser.nickname}+'님과 채팅방'">

               </div>
            <div>
                <form method="get" th:action="@{|/chat/${room3.id}/room2?userId=${room3.siteUser2.id}|}">
                <input type="hidden" name="userId" th:value="${room3.siteUser.id}">
                <button type="submit" >채팅방 입장 </button>
                 </form>
             </div>
        </div>



</div>
</body>
</html>


<script>
    function fetchGet(url, data) {


         let query = Object.keys(data)
             .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k]))
             .join('&');


         return fetch(url + "?" + query, {
             method: "GET",
             headers: {
                 "Content-Type": "application/json",
                 "Accept": "application/json"



             }
         })
             .then(response => response.json())
     }


</script>

<script>

    function Chat__loadMessagesForRoom(roomId) {
    let lastLoadedId = 0; // Initialize the last loaded ID for the room

    // Function to load more messages for the specified room
    function loadMoreMessages() {
        fetchGet(`/chat/${roomId}/messages`, {
            fromId: lastLoadedId
        })
            .then(body => {
                Chat__drawMessages(body.data.messages);
            });
    }



    const Chat__elMessageDiv = $('.chat-subject');

    // Function to draw messages for the room
    function Chat__drawMessages(messages) {
        if (messages.length > 0) {
            // Update the lastLoadedId variable for the room
            lastLoadedId = messages[messages.length - 1].id;
        }

        messages.forEach((message) => {
             const messageHTML = `<div class="chat__message">${message.authorName} : ${message.content}</div>`;
            Chat__elMessageDiv.html(messageHTML);
        });
    }

    loadMoreMessages();
     // Attach an EventSource for the SSE connection specific to the room
    const sse = new EventSource(`/sse/connect/chatRoom__${roomId}`);

    // When a new message is added to the room, load more messages for that room
    sse.addEventListener('chat__messageAdded', e => {
        console.log("sse 실행됨");
        loadMoreMessages();
    });


}

     $('.room-id').each(function () {
    const roomId = $(this).data('room-id');

    Chat__loadMessagesForRoom(roomId);



    // Load initial messages for the room



});

</script>


<script>
<!--    let Chat__lastLoadedId = 0;-->

<!-- function Chat__loadMore() {-->
<!--     fetchGet(`/chat/${roomId}/messages`, {-->
<!--         fromId: Chat__lastLoadedId-->
<!--     })-->
<!--         .then(body => {-->
<!--             Chat__drawMessages(body.data.messages);-->
<!--         });-->
<!-- }-->

<!-- const Chat__elMessageUl = document.querySelector('.chat__message-ul');-->

<!-- function Chat__drawMessages(messages) {-->
<!--     if (messages.length > 0) {-->
<!--         // 메세지를 그리기 전에 Chat__lastLoadedUuid 변수를 갱신합니다.-->
<!--         Chat__lastLoadedId = messages[messages.length - 1].id;-->
<!--     }-->

<!--     messages.forEach((message) => {-->


<!--         Chat__elMessageUl-->
<!--             .insertAdjacentHTML(-->
<!--                 "beforeBegin",-->
<!--                 `<li class="chat__message ${alignClass}">${message.authorName} : ${message.content}</li>`-->
<!--             );-->



<!-- Chat__loadMore();-->


<!-- // SSE 연결-->
<!--    // SSE는 단방향 무전기-->
<!--    // 방향 : 서버 -> 클라이언트-->
<!--    const sse = new EventSource(`/sse/connect/chatRoom__${roomId}`);-->

<!--    // 서버로부터 "chat__messageAdded" 라는 명령이 내려오면 Chat__loadMore 함수를 실행-->
<!--    sse.addEventListener('chat__messageAdded', e => {-->
<!--        Chat__loadMore();-->
<!--    });-->




</script>

