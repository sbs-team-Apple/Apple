<html layout:decorate="~{common/layout}" lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <title></title>

</head>
<div layout:fragment="content" class="container my-3 ml-auto mr-auto">

    <div class="chat-section">
        <div class="chat-container">
            <div class="chat-option-box">
                <div class="chat-option-item flex  justify-start" >
                    <div class="ml-2 mr-4">
                        <a href="/chat/allRoom">
                            <i class="fa-solid fa-right-to-bracket"></i>
                        </a>
                    </div>
                    <div th:text="${toUser.nickname}" class="justify-start"> </div>
                    <div class="dropdown dropdown-bottom dropdown-end chat-option-icon text-right ">
                        <label tabindex="0" class=" m-1 bg-white"><i class="fa-solid fa-gear fa-lg option-icon-img"></i></label>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-40">







                            <li>
                                <a class="flex  justify-end"><button class="btn" id="justsendCyberMoneyBtn" data-toggle="modal" data-target="#cyberMoneyModal">
                                    &nbsp&nbsp&nbspí•˜íŠ¸ ì„ ë¬¼&nbsp&nbsp&nbsp&nbsp
                                </button>
                                <dialog id="my_modal_6" class="modal modal-bottom sm:modal-middle">
                                <div class="modal-box">

                                    <div class="modal-body">
                                        <p class="badge badge-secondary badge-outline mt-3 mb-3" style=" font-size: 1em; color: black; display: inline-block; margin-right: 10px; background-color: #EFE1F8; border-color: #EFE1F8;">
                                            ë³´ìœ ì¤‘ì¸ í•˜íŠ¸ê°œìˆ˜ : <span th:text="${userCyberMoney}" style="font-size: 1em; color: black;"></span>ê°œ
                                        </p>                            <div>í˜¸ê°ì´ ìˆëŠ”ë§Œí¼ í•˜íŠ¸ë¥¼ ë³´ë‚´ì„¸ìš”.</div>
                                        <input style="width:100px; border-color: #B276EE;" type="text" id="justcyberMoneyAmount" class="mb-3 mt-3 input input-sm" required><span>&nbsp&nbspê°œ</span>
                                    </div>

                                    <div class="modal-action" style="display: flex; justify-content: space-between;">
                                        <form method="dialog" style="width: 100%;">
                                            <button style="width: 48%; background-color: #B276EE; color: white;" class="btn btn-sm" id="justsendCyberMoneyConfirmBtn">í™•ì¸</button>
                                            <button style="width: 48%; border-color: #B276EE; color: #989898;" class="btn btn-sm btn-outline" data-dismiss="modal">ë‹«ê¸°</button>
                                        </form>
                                    </div>
                                </div>
                            </dialog>
                                </a>
                            </li>









                            <li><a class="flex justify-end"><button class="btn" onclick="my_modal_5.showModal()">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
                                <dialog id="my_modal_5" class="modal modal-bottom sm:modal-middle">
                                    <div class="modal-box" style="height:180px; width:300px; padding:15px;">
                                        <h3 class="font-bold text-lg">ê²½ê³ !!!!!</h3>
                                        <p class="mt-2">ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œë©´ ë˜ í•˜íŠ¸ë¥¼ ë³´ë‚´ì•¼ì§€ë§Œ ì±„íŒ…ë°©ì´ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤. ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                                        <div class="modal-action mt-2">

                                            <form th:action="@{|/chat/${roomId}/delete|}" method="get">
                                                <input class="hidden" name="userId" th:value="${user.id}">
                                                <button class="btn" type="submit" >ì˜ˆ </button>


                                            </form>
                                            <form method="dialog">
                                                <!-- if there is a button in form, it will close the modal -->

                                                <button class="btn">ì•„ë‹ˆì˜¤</button>
                                            </form>
                                        </div>
                                    </div>
                                </dialog></a></li>


                        </ul>
                    </div>
                </div>
            </div>
            <div class="chat__message-box">


                <ul class="chat__message-ul">

                </ul>
            </div>
            <div class="chat-write-box">
                <div class="chat-write-box-item  ">
                    <form class="chat__write-message flex" onsubmit="Chat__writeMessage(this); return false;">
                        <input type="hidden" name="roomId" th:value="${roomId}">

                        <input  class ="hidden"  type="text" placeholder="ì‘ì„±ì" th:value="${user.nickname}"  name="authorName" autocomplete="off">
                        <div class="emo-button">ğŸ™‚</div>
                        <input class="w-11/12  h-10  mt-2 mb-2  chat-content" type="text" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."  name="content" autocomplete="off">
                        <button class="w-20 chat-write-box-item-button" type="submit" value="ì‘ì„±">ì „ì†¡</button>
                    </form>

                    <div class="emo-box flex flex-wrap" style="display:none;">
                        <div class="flex emo-kind justify-around">
                            <div class="face">ğŸ˜€</div>
                            <div class="symbol">ğŸ‘</div>
                            <div class="nature">â›…</div>
                            <div class="food">ğŸ–</div>

                        </div>

                        <div class="face-emo emo flex flex-wrap">
                            <p>ğŸ˜€</p> <p>ğŸ˜</p> <p>ğŸ˜ƒ</p><p>ğŸ˜„</p>
                            <p>ğŸ˜…</p> <p>ğŸ˜†</p> <p>ğŸ˜‰</p> <p>ğŸ˜‹</p><p>ğŸ˜Š</p><p>ğŸ˜</p>
                            <p>ğŸ˜</p> <p>ğŸ˜˜</p><p>ğŸ˜—</p><p>ğŸ˜´</p><p>ğŸ˜›</p><p>ğŸ˜“</p>
                            <p>ğŸ˜“</p><p>ğŸ˜“</p><p>ğŸ˜“</p><p>ğŸ˜“</p><p>ğŸ˜“</p><p>ğŸ˜“</p>
                            <p>ğŸ˜“</p><p>ğŸ˜“</p><p>ğŸ˜“</p><p>ğŸ˜“</p><p>ğŸ˜“</p><p>&#128527;</p>

                        </div>
                        <div class="symbol-emo emo flex flex-wrap" style="display:none;">
                            <p>ğŸ‘</p> <p>ğŸ‘</p> <p>ğŸ’ª</p><p>ğŸ‘‰</p>
                            <p>â˜</p> <p>âœŒ</p> <p>ğŸ¤</p> <p>ğŸ–</p><p>âœ‹</p><p>ğŸ‘Œ</p>
                            <p>ğŸ‘Š</p> <p>ğŸ¤œ</p><p>ğŸ‘</p><p>ğŸ‘‹</p><p>ğŸ‘‚</p><p>ğŸ‘ƒ</p>
                            <p>ğŸ’¬</p><p>ğŸ’¢</p>

                        </div>
                        <div class="nature-emo emo flex flex-wrap" style="display:none;">
                            <p>ğŸŒ</p> <p>ğŸŒ</p> <p>ğŸŒ—</p><p>ğŸŒ›</p>
                            <p>â˜€</p> <p>ğŸŒ</p> <p>â­</p> <p>â˜</p><p>â›ˆ</p><p>ğŸŒ§</p>
                            <p>ğŸŒ©</p> <p>ğŸŒˆ</p><p>âš¡</p><p>â˜”</p><p>â„</p><p>ğŸ”¥</p>
                            <p>ğŸ„</p><p>ğŸŒŠ</p>

                        </div>
                        <div class="food-emo emo flex flex-wrap" style="display:none;">
                            <p>ğŸ‡</p> <p>ğŸ‰</p> <p>ğŸŒ</p><p>ğŸ</p>
                            <p>ğŸ</p> <p>ğŸ¥</p> <p>ğŸ¥¥</p> <p>ğŸ–</p><p>ğŸ§€</p><p>ğŸ•</p>
                            <p>ğŸ”</p> <p>ğŸŒ­</p><p>ğŸ¨</p><p>ğŸ›</p><p>ğŸœ</p><p>ğŸ®</p>
                            <p>ğŸ·</p><p>ğŸ£</p>

                        </div>




                    </div>
                </div>

            </div>

        </div>



    </div>
    <div class="toUser-img-src" th:text="${toUser.filepath}" style="display:none;"></div>
    <div class="toUser-id" th:text="${'user/detail/'+toUser.id}" style="display:none;"></div>
    <div class="toUser-nickname" th:text="${toUser.nickname}" style="display:none;"></div>
    <div class="toUser-username" th:text="${toUser.username}" style="display:none;"></div>


</div>



</html>

<style>
    body, ul, li{
  margin:0;
  list-style:none;
  padding:0;
          }
a        {
  text-decoration:none;
  color:inherit;
          }
input:focus {
    outline: none;
}

.dropdown-bottom .dropdown-content {


}


.chat-section{
    display:block;

    width:80%;


    margin-left:auto;
    margin-right:auto;
     position:relative;
}
 @media screen and (min-width: 800px) {
    .chat-section {

    width:50%;

    }
 }


.chat-container{


}



.chat__message-box{
        padding-top:20px;
      height:500px;


     overflow-y: scroll; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ë§Œ í™œì„±í™” */
     overflow-x: hidden;
     background-color :#f08dac;
     position:relative;
}

.chat__message-box::-webkit-scrollbar {
        display:none /* Chrome , Safari , Opera */
    }

  @media screen and (max-height: 800px) {

            .chat__message-box{
                    height:300px;

                }

  }


.chat-option-box {
    height:35px;
     background-color :#f0bddb;
     display:flex;
      align-items: center;


}

.chat-option-item {
    display:flex;
    width:100%;


}

.chat-option-icon {

    margin-right:5px;
     text-align: right;
    margin-left:auto;

}

.fa-cog:before, .fa-gear:before{
           background-color :#f0bddb;

}

@media screen and (max-width: 450px) {

    .modal[open] .modal-box {
                position:absolute;
                top:50%;
                left:50%;
                transform:translate(-50%,-50%);

              border-bottom-right-radius:  var(--rounded-box, 1rem);
            border-bottom-left-radius: var(--rounded-box, 1rem);

            width:250px;

    }




}



.chat-write-box {



}
.chat-write-box-item {

   margin-top:10px;
   border: 1px solid black;

}

.chat-write-box-item-button {
    background-color : #f0bddb;
    margin-left:10px;
}


.chat__message{
    margin-bottom:30px;

     max-width:230px;
    border-radius:15px;
    margin-top:20px;
    padding:5px 15px;
}




.chat__message.right {
text-align: left;
background-color: #f0bddb; /* ì›í•˜ëŠ” ë°°ê²½ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
 clear:both;
    float:right;
    margin-right:10px;


}




/* ìƒëŒ€ë°©ì˜ ë©”ì‹œì§€ */
.chat__message.left {
text-align: left;
background-color: white; /* ì›í•˜ëŠ” ë°°ê²½ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
clear:both;
float:left;
    margin-left:55px;

    position:relative;

}

.left-div {
    position:absolute;
    top:-30px;
    left:-50px;
    border:1px solid #bcc0c4;
     border-radius: 50%;

}

.left-div-name{
         position:absolute;
    top:-30px;
    left:0px;

}




.emo-button {
        line-height: 56px;
        margin: 0 10px;

}


.emo-box {
    position:absolute;
    bottom:0;
    left:0;
    width:100%;
    height:150px;
    transform:translate(-0,100%);

     overflow-y: scroll; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ë§Œ í™œì„±í™” */
     overflow-x: hidden;
    border:1px solid black;
}


.emo-box::-webkit-scrollbar {
        display:none /* Chrome , Safari , Opera */
    }
  .emo-kind {
  margin-top:10px;
  margin-bottom:10px;
       width: 348px;
  }


.emo-kind >div{
    margin:0 5px;
}

.emo >p{
    width:22px;
    height:22px; margin: 10px;
}


</style>
<script>

    $(document).ready(function () {
  var chatMessageBox = $(".chat__message-box");
  var chatOptionBox = $(".chat-option-box");

  chatMessageBox.scroll(function () {
    var scrollTop = chatMessageBox.scrollTop();
    chatOptionBox.css("top", scrollTop);
  });
});
</script>


<script th:inline="javascript">
    const roomId = [[${roomId}]];

    const userNickname = /*[[${user.nickname}]]*/ null;
</script>

<script>
    $(document).ready(function() {
    $(".face").click(function() {
        $(".face-emo").show();
        $(".symbol-emo").hide();
        $(".nature-emo").hide();
        $(".food-emo").hide();
    });

    $(".symbol").click(function() {
        $(".face-emo").hide();
        $(".symbol-emo").show();
      $(".food-emo").hide();
        $(".nature-emo").hide();

    });

     $(".nature").click(function() {
        $(".face-emo").hide();
        $(".symbol-emo").hide();
        $(".food-emo").hide();
        $(".nature-emo").show();

    });


     $(".food").click(function() {
        $(".face-emo").hide();
        $(".symbol-emo").hide();
        $(".food-emo").show();
        $(".nature-emo").hide();

    });
});


</script>


<script>
    var emoButton = $(".emo-button");
    emoButton.click(function(event){
      event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ì„ ë§‰ìŒ
           emoBox.toggle();
    });
     emoBox.click(function(event) {
            event.stopPropagation();
        });

    $(document).click(function(event) {
        if (!emoBox.is(event.target) && !emoButton.is(event.target) && emoBox.is(":visible")) {
            emoBox.hide();
        }
    });





</script>


<script>

    var emoBox= $(".emo-box");
    var emo = emoBox.find("p");
    var content=$(".chat-content");

    console.log(emo);

     emo.on("click", function() {
       var clickedText = $(this).text(); // í´ë¦­í•œ <p> íƒœê·¸ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜´
        var currentContent = content.val(); // ì…ë ¥ë€ì˜ í˜„ì¬ ë‚´ìš©ì„ ê°€ì ¸ì˜´
        var newContent = currentContent + " " + clickedText; // ìƒˆë¡œìš´ ë‚´ìš©ì„ ìƒì„±

        content.val(newContent); // ì…ë ¥ë€ì— ìƒˆë¡œìš´ ë‚´ìš©


    });



</script>



<script>
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");

   function fetchPost(url, data) {


       return fetch(url, {
           method: "POST",
           headers: {
               "Content-Type": "application/json",
               "Accept": "application/json",
                [header]: token
           },
           body: JSON.stringify(data),
       })
           .then(response => response.json())
   }

   function fetchGet(url, data) {


       let query = Object.keys(data)
           .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(data[k]))
           .join('&');


       return fetch(url + "?" + query, {
           method: "GET",
           headers: {
               "Content-Type": "application/json",
               "Accept": "application/json"



           }
       })
           .then(response => response.json())
   }
</script>

<script>
    // ì±„íŒ… ë©”ì„¸ì§€ ì‘ì„± ì‹œì‘
    var toUserImgSrc=$(".toUser-img-src").text();
    var toUserDetail=$(".toUser-id").text();
    var toUserNickname=$(".toUser-nickname").text();


    console.log("asda"+toUserImgSrc);

    function Chat__writeMessage(form) {
        form.authorName.value = form.authorName.value.trim();

        if (form.authorName.value.length == 0) {
            alert("ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            form.authorName.focus();

            return;
        }

        form.content.value = form.content.value.trim();

        if (form.content.value.length == 0) {
            form.content.focus();

            return;
        }

        fetchPost(`/chat/${roomId}/writeMessage`, {
            authorName: form.authorName.value,
            content: form.content.value
        })
            .then(console.log);

        form.content.value = '';
        form.content.focus();
    }

    // ì±„íŒ… ë©”ì„¸ì§€ ì‘ì„± ë

    // ì±„íŒ… ë©”ì„¸ì§€ë“¤ ì½ê¸° ì‹œì‘
    // í˜„ì¬ í´ë¼ì´ì–¸íŠ¸ê°€ ë°›ì€ ë©”ì„¸ì§€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
    // ê·¸ë˜ì•¼ ë©”ì„¸ì§€ ìš”ì²­ì‹œì— í•„ìš”í•œ ë¶€ë¶„ë§Œ ê°€ì ¸ì˜¤ê²Œ ë©ë‹ˆë‹¤.
    let Chat__lastLoadedId = 0;

    function Chat__loadMore() {
        fetchGet(`/chat/${roomId}/messages`, {
            fromId: Chat__lastLoadedId
        })
            .then(body => {
                Chat__drawMessages(body.data.messages);
            });
    }

    const Chat__elMessageUl = document.querySelector('.chat__message-ul');

    function Chat__drawMessages(messages) {
        if (messages.length > 0) {
            // ë©”ì„¸ì§€ë¥¼ ê·¸ë¦¬ê¸° ì „ì— Chat__lastLoadedUuid ë³€ìˆ˜ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
            Chat__lastLoadedId = messages[messages.length - 1].id;
        }

        messages.forEach((message) => {
              const isMyMessage = message.authorName === userNickname; // ìì‹ ì˜ ë©”ì‹œì§€ ì—¬ë¶€ í™•ì¸
              console.log(userNickname);
              const alignClass = isMyMessage ? 'right' : 'left'; // ì˜¤ë¥¸ìª½ ë˜ëŠ” ì™¼ìª½ í´ë˜ìŠ¤ ì„ íƒ



            Chat__elMessageUl
                .insertAdjacentHTML(
                    "beforeBegin",
                    `<li class="chat__message ${alignClass}"> ${message.content}</li>`
                );
            if (alignClass === 'left') {
            const imgDiv = $('<div class="avatar left-div">' +
    '<div class="w-10 rounded-full">' +
    '<a href=/' + toUserDetail + '>' +
    '<img src="' + toUserImgSrc + '">' +
    '</a>' +
    '</div>' +
    '</div>');


      const toUserName = $('<div class="left-div-name"></div>').text(toUserNickname);


        $(".left:last").append(imgDiv);
        $(".left:last").append(toUserName);

     }

        // ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆì˜ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ê°€ì¥ ì•„ë˜ë¡œ ì´ë™
        const scrollContainer = document.querySelector(".chat__message-box"); // ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆì˜ ì„ íƒìë¥¼ ì ì ˆíˆ ë³€ê²½
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
        });
    }

    Chat__loadMore();

    // SSE ì—°ê²°
    // SSEëŠ” ë‹¨ë°©í–¥ ë¬´ì „ê¸°
    // ë°©í–¥ : ì„œë²„ -> í´ë¼ì´ì–¸íŠ¸
    const sse = new EventSource(`/sse/connect/chatRoom__${roomId}`);

    // ì„œë²„ë¡œë¶€í„° "chat__messageAdded" ë¼ëŠ” ëª…ë ¹ì´ ë‚´ë ¤ì˜¤ë©´ Chat__loadMore í•¨ìˆ˜ë¥¼ ì‹¤í–‰
    sse.addEventListener('chat__messageAdded', e => {
        Chat__loadMore();
    });

    // ì±„íŒ… ë©”ì‹œì§€ë“¤ ì½ê¸° ë


</script>

<script>
    $('#justsendCyberMoneyBtn').click(function () {
     my_modal_6.showModal();
     console.log('Button clicked');

     // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ ì „ì— ê¸°ì¡´ í•¸ë“¤ëŸ¬ ì‚­ì œ
     $('#justsendCyberMoneyConfirmBtn').off('click');

     // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
     $('#justsendCyberMoneyConfirmBtn').click(function () {
         var amount = $('#justcyberMoneyAmount').val();
         var userCyberMoney = parseInt([[${userCyberMoney}]]);

         if (amount > userCyberMoney) {
             alert("í•˜íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
             $('#justcyberMoneyModal').modal('hide');
             isSending = false;
             return;
         }

         var csrfToken = $("meta[name='_csrf']").attr("content");
         var csrfHeader = $("meta[name='_csrf_header']").attr("content");


         var heartUsername = $('.toUser-nickname').text(); // ë³€ê²½ëœ ë¶€ë¶„


         $.ajax({
    type: 'POST',
    url: '/user/cybermoney/JustSend',
    data: 'heartUsername=' + heartUsername + '&amount=' + amount,
    beforeSend: function (xhr) {
        xhr.setRequestHeader(csrfHeader, csrfToken);
    },
    success: function () {
        alert("í•˜íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        // ì—¬ê¸°ì— ì±„íŒ… ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•˜ëŠ” ì½”ë“œ ì¶”ê°€
        var sentMessage = heartUsername + " ë‹˜ì—ê²Œ í•˜íŠ¸ " +  amount + "ê°œë¥¼ ì„ ë¬¼ í–ˆì–´ìš”.";
        fetchPost(`/chat/${roomId}/writeMessage`, {
            authorName: userNickname,
            content: sentMessage
        });
        location.reload();
        $('#cyberMoneyModal').modal('hide');
    },
    error: function (error) {
        alert("Error: " + error.responseText);
    },
    complete: function () {
        isSending = false;
    }
});
     });
 });

</script>