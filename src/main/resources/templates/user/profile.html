<html layout:decorate="~{common/layout}" lang="en">

<head>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

</head>


<div layout:fragment="content" class="container m-auto flex justify-center flex-col items-center">
    <div>
        <div style="display: none;">
            <p class="badge badge-secondary" style="display: inline-block; margin-right: 10px;">사용 가능한 하트: <span th:text="${userCyberMoney}"></span>개</p>
            <p class="badge badge-secondary" style="display: inline-block;">선물 받은 하트: <span th:text="${receivedCyberMoney}"></span>개</p>
        </div>

        <div class="flex justify-center">
            <img th:src="@{|${receivedSiteUser.filepath}|}" alt="User Image" style="max-width: 300px; max-height: 300px;">
        </div>

        <div th:text="'최소하트 : ' + ${receivedSiteUser.minHeart}"></div>

        <div th:text="'자기소개 : ' + ${receivedSiteUser.About_Me}"></div>
        <div th:text="'닉네임 : ' + ${receivedSiteUser.nickname}"></div>
        <div th:text="'나이 : ' + ${receivedSiteUser.age}"></div>
        <div th:text="'지역 : ' + ${receivedSiteUser.living}"></div>
        <div th:text="'취미 : ' + ${receivedSiteUser.hobbyList}"></div>
        <div th:text="'키 : ' + ${receivedSiteUser.tall}"></div>
        <div th:text="'체형 : ' + ${receivedSiteUser.body_type}"></div>
        <div th:text="'흡연 : ' + ${receivedSiteUser.smoking}"></div>
        <div th:text="'음주 : ' + ${receivedSiteUser.drinking}"></div>
        <div th:text="'성격 : ' + ${receivedSiteUser.styleList}"></div>
        <div th:text="'종교 : ' + ${receivedSiteUser.religion}"></div>
        <div th:text="'MBTI : ' + ${receivedSiteUser.mbti}"></div>
        <div th:text="'학교 : ' + ${receivedSiteUser.school}"></div>
        <div th:text="'직업 : ' + ${receivedSiteUser.job}"></div>

        <div class="text-xl flex justify-center">원하는 이상형</div>
        <div th:text="'선호하는 나이 : ' + ${receivedSiteUser.desired_age}"></div>
        <div th:text="'선호하는 지역 : ' + ${receivedSiteUser.desired_living}"></div>
        <div th:text="'선호하는 이성 키 : ' + ${receivedSiteUser.desired_tall}"></div>
        <div th:text="'선호하는 이성 체형 : ' + ${receivedSiteUser.desired_body_type}"></div>
        <div th:text="'선호하는 이성 흡연 : ' + ${receivedSiteUser.desired_smoking}"></div>
        <div th:text="'선호하는 이성 음주 : ' + ${receivedSiteUser.desired_drinking}"></div>
        <div th:text="'선호하는 이성 성격 : ' + ${receivedSiteUser.desired_styleList}"></div>
        <div th:text="'선호하는 이성 종교 : ' + ${receivedSiteUser.desired_religion}"></div>
        <div th:text="'선호하는 이성 MBTI : ' + ${receivedSiteUser.desired_mbti}"></div>


        <div>
            <a class="btn btn-outline btn-info" th:href="@{'/user/report/' + ${receivedSiteUser.id}}">신고하기</a>
            <a class="btn btn-outline btn-info" th:href="@{'/user/add_interest/' + ${receivedSiteUser.id}}">
                <span th:text="${isInterested ? '관심 해제' : '관심 등록'}"></span>
            </a>
            <button th:if="${chatRoom == null  && log ==null} " id="sendCyberMoneyBtn" class="btn btn-outline btn-info"
                    data-toggle="modal" data-target="#cyberMoneyModal">채팅방 만들기
            </button>
        </div>


        <a class="nav-link" th:if="${#authorization.expression('hasRole(''ADMIN'')')}"
           th:href="@{'/admin/punish/' + ${receivedSiteUser.id}}">제재하기</a>


        <dialog id="my_modal_5" class="modal modal-bottom sm:modal-middle">
            <div class="modal-box">
                <h3 class="modal-title">사이버머니 보내기</h3>
                <div class="modal-body">
                    <p>금액을 입력해주세요:</p>
                    <input type="number" id="cyberMoneyAmount" class="form-control" required>

                    <p>받는사람:</p>
                    <div th:text="${receivedSiteUser.username}" id="recipientUsername" class="form-control"></div>
                </div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn btn-secondary" data-dismiss="modal">닫기</button>
                        <button class="btn btn-primary" id="sendCyberMoneyConfirmBtn">확인</button>
                    </form>
                </div>
            </div>
        </dialog>
    </div>
</div>
</html>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
    var isSending = false;

    $('#sendCyberMoneyBtn').click(function () {
        if (isSending) return;
        isSending = true;

        my_modal_5.showModal();

        var siteUserUsernameElement = $("#recipientUsername");
        var recipientUsername = siteUserUsernameElement.text();

        // 이벤트 핸들러 등록 전에 기존 핸들러 삭제
        $('#sendCyberMoneyConfirmBtn').off('click');

        // 이벤트 핸들러 등록
        $('#sendCyberMoneyConfirmBtn').click(function () {
            var amount = $('#cyberMoneyAmount').val();
            var minHeart = parseInt([[${receivedSiteUser.minHeart}]]);
            var userCyberMoney = parseInt([[${userCyberMoney}]]);

            if (amount < minHeart) {
                alert("최소하트보다 작습니다.");
                $('#cyberMoneyModal').modal('hide');
                isSending = false;
                return;
            }

            if (amount > userCyberMoney) {
                alert("하트가 부족합니다.");
                $('#cyberMoneyModal').modal('hide');
                isSending = false;
                return;
            }


            var csrfToken = $("meta[name='_csrf']").attr("content");
            var csrfHeader = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                type: 'POST',
                url: '/user/cybermoney/send',
                data: 'recipientUsername=' + recipientUsername + '&amount=' + amount,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function () {
                alert("사이버 머니가 성공적으로 전송 되었습니다.");
                    location.reload();
                    $('#cyberMoneyModal').modal('hide');

                },
                error: function (error) {
                    alert("Error: " + error.responseText);
                },
                complete: function () {
                    isSending = false;
                }
            });
        });
    });
});

</script>
