<html layout:decorate="~{common/layout}" lang="en">

<head>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

</head>


<div layout:fragment="content" class="container m-auto flex justify-center flex-col items-center">
    <div class="mb-5 mt-5"
         style="width: 270px; border-radius: 20px; margin-bottom:80px;
          box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.3);">
        <div>
            <div>
                <div class="photo" style="position: relative;">
                    <div class="flex justify-center" style="border-bottom: 2px solid #ccc;">
                        <img th:src="@{|${receivedSiteUser.filepath}|}" alt="User Image"
                             style="width: 270px; height: 270px; object-fit: cover;border-top-left-radius: 20px; border-top-right-radius: 20px;">
                    </div>

                    <div style="position: absolute; top: 10px; right: 10px;">
                        <a th:href="@{'/user/add_interest/' + ${receivedSiteUser.id}}">
                            <div class="bg-white p-4 px-4 rounded-full absolute -left-6 -top-6 shadow-md">
                            <span th:if="${isInterested}">
                                                         <span style="position: relative;">
                    <i class="fa-solid fa-star fa-xl" style="color: yellow;"></i>
                                </span>
                                 </span>
                                <span th:unless="${isInterested}">
                                <span style="position: relative;">
                                <i class="fa-regular fa-star fa-xl"></i>
                                </span>
                                 </span>
                            </div>
                        </a>
                    </div>
                </div>
                <div>
                    <button th:if="${chatRoom == null && log == null}" id="sendCyberMoneyBtn"
                            style="padding:5px 15px; border-radius:10px; border:3px solid purple;"
                            data-toggle="modal" data-target="#cyberMoneyModal">
                        <i class="fa-solid fa-comment mr-1"></i>하트 보내기
                    </button>
                </div>
                <div class="flex">
                    <div th:text="${receivedSiteUser.nickname + ', ' + receivedSiteUser.age}+', '+${receivedSiteUser.mbti}"
                         class="ml-2 mr-2"
                         style="font-size: 25px; font-weight: bold; position: relative;">
                    </div>
                    <div>
                        <a style="padding:5px 15px; border-radius:10px; border:3px solid red;"
                           th:href="@{'/user/report/' + ${receivedSiteUser.id}}">
                            dfdsf</a>
                    </div>
                </div>

                <div class="ml-2 mr-2 mb-2" th:text="${receivedSiteUser.About_Me}"
                     style="max-width: 250px; word-wrap: break-word;"></div>

                <div class="ml-2 mr-2 info_wrap">
                    <span><i class="fa-solid fa-location-dot"></i><span
                            th:text="${receivedSiteUser.living}"></span></span>
                    <span><i class="fa-solid fa-briefcase"></i><span th:text="${receivedSiteUser.job}"></span></span>
                </div>
                <div class="ml-2 mr-2 info_wrap">
                    <span><i class="fa-solid fa-tape"></i><span th:text="${receivedSiteUser.tall}+'cm'"></span></span>
                    <span><i class="fa-solid fa-person"></i><span th:text="${receivedSiteUser.body_type}"></span></span>
                </div>
                <div class="ml-2 mr-2 info_wrap">
                    <span><i class="fa-solid fa-beer-mug-empty"></i><span th:text="${receivedSiteUser.drinking}"></span></span>
                    <span><i class="fa-solid fa-smoking"></i><span th:text="${receivedSiteUser.smoking}"></span></span>
                </div>

                <div class="ml-2 mr-2 mb-2 info_wrap">
                    <span><i class="fa-solid fa-school"></i><span th:text="${receivedSiteUser.school}"></span></span>
                    <span><span th:text="'종교:  ' + ${receivedSiteUser.religion}"></span></span>
                </div>
                <div class="ml-2" th:text="'성격 : ' + ${receivedSiteUser.styleList}"></div>
                <div class="ml-2" th:text="'취미 : ' + ${receivedSiteUser.hobbyList}"></div>
            </div>

            <div>
                <div class="text-xl flex justify-center">
                    <button onclick="show_desired()" id="up_down"
                            style="border: 1px solid black; border-radius: 10px; padding: 0 90px; margin: 10px 0;">
                        <span>이상형</span><i id="icon" class="fa-solid fa-caret-down ml-1"></i>
                    </button>
                </div>
                <div class="mb-3" style="display:none;" id="all">
                    <div class="ml-2" th:text="'나이 : ' + ${receivedSiteUser.desired_age}"></div>
                    <div class="ml-2" th:text="'지역 : ' + ${receivedSiteUser.desired_living}"></div>
                    <div class="ml-2" th:text="'키 : ' + ${receivedSiteUser.desired_tall}"></div>
                    <div class="ml-2" th:text="'체형 : ' + ${receivedSiteUser.desired_body_type}"></div>
                    <div class="ml-2" th:text="'흡연 : ' + ${receivedSiteUser.desired_smoking}"></div>
                    <div class="ml-2" th:text="'음주 : ' + ${receivedSiteUser.desired_drinking}"></div>
                    <div class="ml-2" th:text="'성격 : ' + ${receivedSiteUser.desired_styleList}"></div>
                    <div class="ml-2" th:text="'종교 : ' + ${receivedSiteUser.desired_religion}"></div>
                    <div class="ml-2" th:text="'MBTI : ' + ${receivedSiteUser.desired_mbti}"></div>
                </div>
            </div>
            <script>
                var isUp = false;
                function show_desired(){
                var iconElement = document.getElementById("icon");
                var contentElement = document.getElementById("all");
                if (isUp) {
                iconElement.classList.remove("fa-caret-up");
                iconElement.classList.add("fa-caret-down");
                contentElement.style.display = "none"; // 숨김
                } else {
                iconElement.classList.remove("fa-caret-down");
                iconElement.classList.add("fa-caret-up");
                contentElement.style.display = "block"; // 보임
                    }
                isUp = !isUp;
                }
            </script>
        </div>

        <div style="display: none;">
            <p class="badge badge-secondary" style="display: inline-block; margin-right: 10px;">사용 가능한 하트: <span
                    th:text="${userCyberMoney}"></span>개</p>
            <p class="badge badge-secondary" style="display: inline-block;">선물 받은 하트: <span
                    th:text="${receivedCyberMoney}"></span>개</p>
        </div>

        <a class="nav-link" th:if="${#authorization.expression('hasRole(''ADMIN'')')}"
           th:href="@{'/admin/punish/' + ${receivedSiteUser.id}}">제재하기</a>


        <dialog id="my_modal_5" class="modal modal-bottom sm:modal-middle">
            <div class="modal-box">
                <p>받는사람:</p>
                <div th:text="${receivedSiteUser.username}" id="recipientUsername" class="form-control"></div>
                <div class="modal-body">
                    <p class="badge badge-secondary badge-outline" style="display: inline-block; margin-right: 10px;">보유중인 하트개수 : <span th:text="${userCyberMoney}"></span>개</p>

                    <div th:text="'하트갯수를 입력해주세요. (최소하트 : ' + ${receivedSiteUser.minHeart} + '개)'"></div>
                    <input type="number" id="cyberMoneyAmount" class="input input-sm input-bordered input-warning" required>


                </div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn btn-secondary" data-dismiss="modal">닫기</button>
                        <button class="btn btn-primary" id="sendCyberMoneyConfirmBtn">확인</button>
                    </form>
                </div>
            </div>
        </dialog>
    </div>

    <div th:include="common/menu.html" class="tap_bar"></div>
    <style>
        .star-outline {
    display: inline-block;
    color: transparent;
    text-shadow: 0 0 0 black;
  }
        .info_wrap {
        display: flex;
        }

        .info_wrap > span {
            width: calc(100% / 2);
            display: block;
        }


        .tap_bar {
                position: fixed;
                width: 100%;
                bottom : 0;
            }
    </style>
</div>
</html>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
    var isSending = false;

    $('#sendCyberMoneyBtn').click(function () {
        if (isSending) return;
        isSending = true;

        my_modal_5.showModal();

        var siteUserUsernameElement = $("#recipientUsername");
        var recipientUsername = siteUserUsernameElement.text();

        // 이벤트 핸들러 등록 전에 기존 핸들러 삭제
        $('#sendCyberMoneyConfirmBtn').off('click');

        // 이벤트 핸들러 등록
        $('#sendCyberMoneyConfirmBtn').click(function () {
            var amount = $('#cyberMoneyAmount').val();
            var minHeart = parseInt([[${receivedSiteUser.minHeart}]]);
            var userCyberMoney = parseInt([[${userCyberMoney}]]);

            if (amount < minHeart) {
                alert("최소하트보다 작습니다.");
                $('#cyberMoneyModal').modal('hide');
                isSending = false;
                return;
            }

            if (amount > userCyberMoney) {
                alert("하트가 부족합니다.");
                $('#cyberMoneyModal').modal('hide');
                isSending = false;
                return;
            }


            var csrfToken = $("meta[name='_csrf']").attr("content");
            var csrfHeader = $("meta[name='_csrf_header']").attr("content");

            $.ajax({
                type: 'POST',
                url: '/user/cybermoney/send',
                data: 'recipientUsername=' + recipientUsername + '&amount=' + amount,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function () {
                alert("하트가 성공적으로 전송 되었습니다.");
                    location.reload();
                    $('#cyberMoneyModal').modal('hide');

                },
                error: function (error) {
                    alert("Error: " + error.responseText);
                },
                complete: function () {
                    isSending = false;
                }
            });
        });
    });
});

</script>
